---
title: "DESeq, Heatmap and Volcano"
author: "Phoebe Fei"
date: "2022-08-17"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{css style_settings, echo = FALSE}
blockquote { 
    font-size: 14px; 
    font-style: italic;
}
h1{
    font-size: 22px;
}
h2{
    font-size: 20px;
}
h3{
    font-size: 18px;
}
h4{
    font-size: 16px;
}

```

### Libraries
```{r, message=FALSE}
library(stringr)
library(DESeq2)
library(vsn)
library(ggplot2)
library(apeglm)
library(dplyr)
library(magrittr)
library(pheatmap)
library(EnhancedVolcano)
library(viridis)
library(biomaRt)
library(PCAtools)
library(UpSetR)
library(edgeR)
library(scopetools)
```

## Functions

### Result Table & HeatMap Table Generation

Result Table
```{r}
restable <- function(min_fc = 2, max_p = 0.05, n_top_genes = 20, deseq, cont, exclude_gene = ""){
  MIN_L2FC=log2(min_fc)
  res_table <- results(deseq, independentFiltering = TRUE, contrast = cont) %>% as.data.frame(.) %>% dplyr::select(everything()) %>%
    filter(log2FoldChange >= min_fc | log2FoldChange <= -min_fc ) %>%
    filter(padj <= max_p) %>%
    arrange(padj)
  if(exclude_gene != ""){
    res_table <- res_table[-which(rownames(res_table) %in% exclude_gene),] %>% arrange(padj)
  }
  print(res_table[1:n_top_genes, ])
  return(res_table)
}
```

Heatmap Table

```{r}
#include a exclude genes so that some background genes might be excluded; select top = 40 based on p values
heattable <- function(deseq, res_table, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc = 2, max_p = 0.05, select_genes = 40, exclude_genes = ""){
  #rlog scaled
  deseq.vst <- varianceStabilizingTransformation(deseq, blind = TRUE)
  #select padj
  seg.herv <- subset(res_table, padj < max_p & (log2FoldChange > log2(min_fc) | log2FoldChange < -log2(min_fc)))
  #Select the HREVs/Genes
  herv_names  <- str_extract(rownames(seg.herv), select_string)
  seg.herv.1 <- seg.herv[(rownames(seg.herv) %in%  herv_names),]
  seg.herv.1 <- seg.herv.1[!(rownames(seg.herv.1) %in% exclude_genes),]
  if(nrow(seg.herv.1) < select_genes){
    print(paste0("Only ", nrow(seg.herv.1), "rows significant after exclusion. Keeping all."))
    vst.herv <- deseq.vst[rownames(seg.herv.1),] %>% assay
  }else{
    seg.herv.1 <- arrange(seg.herv.1, padj)
    vst.herv <- deseq.vst[rownames(seg.herv.1[1:select_genes,]),] %>% assay
  }
  return(vst.herv)
}

```

### Load Data

```{r}
#gene annotation
load("/Users/phoebefei/Library/CloudStorage/OneDrive-med.cornell.edu/WCM/Metastatic UM Prj/primary_UM/analysis2/03-gene_data.Rdata")
#genes.annot
load("/Users/phoebefei/Library/CloudStorage/OneDrive-med.cornell.edu/WCM/Metastatic UM Prj/Rdatas/count_data.RData")
load("/Users/phoebefei/Library/CloudStorage/OneDrive-med.cornell.edu/WCM/Metastatic UM Prj/Rdatas/metadata.RData")
```

Interested HERVs

```{r}
herv_profile <- c('ERVLE_17p11.2c','LTR46_Xq11.1','HERVH_6q24.1b','HERVH_3q21.3a','MER4B_3q21.2','HERVH_10q23.32','HML3_19q13.2','HERVI_9q22.1','MER4_1p21.3','HML3_3q21.2','ERVLE_5q13.2a','HERV3_19q13.42a','HERVE_Xp11.23','ERV316A3_6p21.33c','MER101_19q13.2c','ERVLE_2p13.2a','MER4B_12q22')
```

Take out the pre-treatment subgroup for mskcc, non-cell-line group for nilsson

```{r}
meta_sub <- mskcc_meta[which(mskcc_meta$Treatment_stage == "Pre-tx"),] %>% arrange(RECIST_pre_tx)
nilson_sub <- nilsson_meta[which(nilsson_meta$Cell_line == "Liver metastasis" | nilsson_meta$Cell_line == "Subcutaneous metastasis"),]
```

Combine the metadata
```{r}
inter_col <- intersect(intersect(colnames(meta_sub), colnames(nilson_sub)), colnames(TCGA_meta))
pm_meta <- rbind(meta_sub[,inter_col], nilson_sub[,inter_col], TCGA_meta[,inter_col]) %>% arrange(Cluster)
```

Combine HERV+Gene 

```{r}
all_bind <- rbind(all_genes, all_hervs[,colnames(all_genes)])

```

### DESeq Objects

#### HERV+Gene in All samples PCA Plotting

```{r}
DESeq.all <- DESeqDataSetFromMatrix(countData = as.matrix(all_bind[,rownames(metadata_all)]),
                                   colData = metadata_all,
                                   design = ~ Batch) 

```

Mean SD Plot + PCA
```{r}
par(mar=c(11, 8.1, 4.1, 2.1))
#size factor
DESeq.all <- estimateSizeFactors(DESeq.all)
#normalize & log-sized
DESeq.all_norm <- counts(DESeq.all, normalized = TRUE)
boxplot(log2(DESeq.all_norm+1), notch=FALSE, main = "Size-factor-normalized read counts", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.all,"log.norm.counts") <- log2(DESeq.all_norm+1)

#SD and PCA plot
msd.all <- vsn::meanSdPlot(DESeq.all@assays@data@listData$log.norm.counts, ranks=FALSE, plot = FALSE)
msd.all$gg + ggtitle("Sequencing depth normalized log2(read counts)") + ylab("standard deviation")
```

```{r}
DESeq.all$Age <- as.numeric(DESeq.all$Age)
#PCA
DESeq.all.trans <- DESeq(DESeq.all)
all.vst <- assay(vst(DESeq.all.trans))
all.pca <- pca(all.vst, metadata = colData(DESeq.all), removeVar = 0.1)
```

PCA Visualize

```{r}
screeplot(all.pca, axisLabSize = 18, titleLabSize = 22) + ggtitle("SCREE Plot for Gene + HERVs")
```
```{r}
biplot(all.pca, lab = NULL, colby = "Batch", legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by Batch")
biplot(all.pca, lab = NULL, colby = "toMet", legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by Development of Metastasis")
biplot(all.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by Age")
biplot(all.pca, lab = NULL, colby = "BAP1",legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by BAP1 Status")
biplot(all.pca, lab = NULL, colby = "BAP1_type",legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by BAP1 Type")
biplot(all.pca, lab = NULL, colby = "Sex",legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by Sex")
```
```{r, fig.width = 6, fig.height = 4}
biplot(all.pca, lab = all.pca$metadata$Sample, colby = "Cell_line", legendPosition = 'right') + ggtitle("PCA, Gene+HERV\nColor by Cell Line")
#ggsave("Gene_HERV_all.png")
```

### Correct on the batch: compare both mets data
```{r}
batch_cols <- intersect(colnames(nilson_sub),colnames(meta_sub))
batch_meta <- rbind(nilson_sub[,batch_cols], meta_sub[,batch_cols])

```

```{r}
#create the object
DESeq.herv.batch <- DESeqDataSetFromMatrix(countData = as.matrix(mets_hervs[,rownames(batch_meta)]),
                                   colData = batch_meta,
                                   design = ~ Batch) 

```


#### Process count info 
```{r, fig.width = 10, fig.height = 6}
#size factor
DESeq.herv.batch <- estimateSizeFactors(DESeq.herv.batch)
#normalize & log-sized
DESeq.herv.batch_norm <- counts(DESeq.herv.batch, normalized = TRUE)
boxplot(log2(DESeq.herv.batch_norm+1), notch=FALSE, main = "Size-factor-normalized read counts", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.herv.batch,"log.norm.counts") <- log2(DESeq.herv.batch_norm+1)
```


```{r}
#SD and PCA plot
msd.herv.batch <- vsn::meanSdPlot(DESeq.herv.batch@assays@data@listData$log.norm.counts, ranks=FALSE, plot = FALSE)
msd.herv.batch$gg + ggtitle("Sequencing depth normalized log2(read counts)") + ylab("standard deviation")
DESeq.herv.batch.trans <- DESeq(DESeq.herv.batch)
herv.batch.vst <- assay(varianceStabilizingTransformation(DESeq.herv.batch.trans))
herv.batch.pca <- pca(herv.batch.vst, metadata = colData(DESeq.herv.batch.trans), removeVar = 0.1)
```

PCA Visualize

```{r}
screeplot(herv.batch.pca, axisLabSize = 18, titleLabSize = 22) + ggtitle("SCREE Plot for HERVs, 2 Metastatic Samples")
biplot(herv.batch.pca, lab = NULL, colby = "Batch",legendPosition = 'right') + ggtitle("PCA, HERVs 2 Metastatic Samples\nColor by Batch")
biplot(herv.batch.pca, lab = NULL, colby = "BAP1", legendPosition = 'right') + ggtitle("PCA, HERVs 2 Metastatic Samples\nColor by BAP1 Status")
biplot(herv.batch.pca, lab = NULL, colby = "BAP1_type",legendPosition = 'right') + ggtitle("PCA, HERVs 2 Metastatic Samples\nColor by BAP1 Mutation Type")
biplot(herv.batch.pca, lab = NULL, colby = "Sex", legendPosition = 'right') + ggtitle("PCA, HERVs 2 Metastatic Samples\nColor by Sex")
```
```{r, fig.height = 4, fig.width = 6}
biplot(herv.batch.pca, lab = herv.batch.pca$metadata$Sample, colby = "Cell_line", legendPosition = 'right') + ggtitle("PCA, HERVs 2 Metastatic Samples\nColor by Sample Cell Line")
#ggsave("PCA Met Batches.png")
```

```{r}
#Run the DESeq with LRT method
DESeq.herv.batch <- DESeq(DESeq.herv.batch, test = "LRT", reduced = ~1)
```

DE table on HERV

```{r}
#resultsNames(DESeq.herv.batch)
#[1] "Intercept"              "Batch_Nilsson_vs_MSKCC"
herv_res_batch <- restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.herv.batch)
batch_hervs <- rownames(herv_res_batch)
```
Unsupervised Clustering of the samples

```{r, fig.width = 8, fig.height = 12}
breaklist <- seq(-3, 3, by = 0.25)
herv_res_heat <- heattable(DESeq.herv.batch, herv_res_batch, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc = 2, max_p = 0.01, select_genes = 50, exclude_genes = "")
pheatmap(herv_res_heat, scale="none",main = "Hirachical Clustering Heatmap of Met Samples",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = TRUE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = batch_meta[,"Batch", drop = FALSE])

```


### Primary vs. Mets

Run Primary vs. Metastatic

```{r}
#create the object
DESeq.herv.pm <- DESeqDataSetFromMatrix(countData = as.matrix(all_hervs[,rownames(pm_meta)]),
                                   colData = pm_meta,
                                   design = ~ Status) 
DESeq.herv.pm$Status <- relevel(DESeq.herv.pm$Status, ref = "Primary")
```


#### Process count info 
```{r, fig.width = 10, fig.height = 6}
#size factor
DESeq.herv.pm <- estimateSizeFactors(DESeq.herv.pm)
#normalize & log-sized
DESeq.herv.pm_norm <- counts(DESeq.herv.pm, normalized = TRUE)
boxplot(log2(DESeq.herv.pm_norm+1), notch=FALSE, main = "Size-factor-normalized read counts", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.herv.pm,"log.norm.counts") <- log2(DESeq.herv.pm_norm+1)
```


```{r}
#SD and PCA plot
msd.herv.pm <- vsn::meanSdPlot(DESeq.herv.pm@assays@data@listData$log.norm.counts, ranks=FALSE, plot = FALSE)
msd.herv.pm$gg + ggtitle("Sequencing depth normalized log2(read counts)") + ylab("standard deviation")
DESeq.herv.pm.trans <- DESeq(DESeq.herv.pm)
herv.pm.vst <- assay(varianceStabilizingTransformation(DESeq.herv.pm.trans))
herv.pm.pca <- pca(herv.pm.vst, metadata = colData(DESeq.herv.pm.trans), removeVar = 0.1)
```

PCA Visualize

```{r}
screeplot(herv.pm.pca, axisLabSize = 18, titleLabSize = 22) + ggtitle("SCREE Plot for HERVs, Primary + Metastatic")
biplot(herv.pm.pca, lab = NULL, colby = "Cluster",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Cluster")
biplot(herv.pm.pca, lab = NULL, colby = "Status",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Status")
biplot(herv.pm.pca, lab = NULL, colby = "toMet",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Metastasis Development")
biplot(herv.pm.pca, lab = NULL, colby = "Batch",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Batch")
biplot(herv.pm.pca, lab = NULL, colby = "GNAQ_site", legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by GNAQ Mutation Site")
biplot(herv.pm.pca, lab = NULL, colby = "BAP1", legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by BAP1 Status")
biplot(herv.pm.pca, lab = NULL, colby = "BAP1_type",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by BAP1 Mutation Type")
biplot(herv.pm.pca, lab = NULL, colby = "Sex", legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Sex")
biplot(herv.pm.pca, lab = NULL, colby = "SF3B1",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by SF3B1 Status")
```

```{r, fig.height=6, fig.width=8}
options(ggrepel.max.overlaps = Inf)
biplot(herv.pm.pca, lab = herv.pm.pca$metadata$Sample, colby = "Cell_line",legendPosition = 'right') + ggtitle("PCA, HERVs Primary + Mets\nColor by Cell Line")
#ggsave("all HERVs Cell Line.png")
```


PCA Loading Plot
```{r, fig.height = 8, fig.width = 4}
plotloadings(herv.pm.pca,
    components = getComponents(herv.pm.pca, c(1,2)),
    rangeRetain = 0.1,
    labSize = 4.0,
    title = 'Loadings plot for primary + metastatic HERVs',
    subtitle = 'PC1, PC2',
    caption = 'Top 1% variables',
    shape = 24,
    col = c('limegreen', 'black', 'red3'),
    drawConnectors = TRUE)
   #max.overlap = Inf

```

```{r}
#DESeq.herv.pm$Cluster <- relevel(DESeq.herv.pm$Cluster, ref = "Metastatic")
DESeq.herv.pm <- DESeq(DESeq.herv.pm,parallel = T,test = "LRT", reduced = ~1)
```

DE table on HERV

```{r}
#resultsNames(DESeq.herv.pm)
#"Intercept"                    "Status_Primary_vs_Metastatic"
#Mets vs. All
herv_res_pm<-restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.herv.pm, cont = c("Status","Metastatic","Primary"))
#Mets vs. All, excluding the batch hervs
herv_res_pm_filt <- restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.herv.pm, cont = c("Status","Metastatic","Primary"), exclude_gene = batch_hervs)
print(paste0(nrow(herv_res_pm_filt), " of HERVs were reported to be significant."))
```

```{r, eval = FALSE}
write.csv(herv_res_pm_filt, "herv_res_pm_filt.csv")
```
QQ Plot

```{r}
herv_res_pm_q <- results(DESeq.herv.pm) %>% as.data.frame()
Norm_quantile<- sort(-log10(seq(1, 1/nrow(herv_res_pm_q), length.out = nrow(herv_res_pm_q))), decreasing = TRUE)
herv_res_pm_q <- herv_res_pm_q[order(herv_res_pm_q$padj, decreasing  = FALSE),]
herv_res_pm_q["Normal_Quantile"] <- Norm_quantile
ggplot(herv_res_pm_q, aes(x = Normal_Quantile, y =-log10(padj))) + geom_point()+geom_abline(intercept = 0, slope = 1, color="red") + xlab("Negative Log Normal Quantile (Expected)")+ylab("Negative Log 10 P Values (Observed)")+ggtitle("QQ Plot for HERV Primary vs Mets\nDesign=RECIST")
```

Heatmap

```{r}
#pm_heat <- heattable(DESeq.herv.pm, herv_res_pm, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc =2, max_p = 0.01) 
pm_heat_filt <- heattable(DESeq.herv.pm, herv_res_pm_filt, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc =2, max_p = 0.01,exclude_genes = batch_hervs) 
pm_heat_clustering <- heattable(DESeq.herv.pm, herv_res_pm_filt, select_string = "^(ERV|HERV|LTR|MER|HML).+",min_fc =2, max_p = 0.01,select_genes = 50, exclude_genes = batch_hervs)
```

```{r,fig.height = 12, fig.width = 12}
breaklist <- seq(-3, 3, by = 0.25)
#pheatmap(pm_heat, scale="row",main = "DE HERVs, All Primary vs. Pre-tx Metastatic\nCutoff p=0.01,Top 49 HERVs",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE], gaps_col = 80)

pheatmap(pm_heat_clustering, scale="row",main = "DE HERVs Clustering, Primary vs. Pre-tx Metastatic\nCutoff p= 0.01,Top 40 HERVs",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = TRUE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE], gaps_col = 80)

pheatmap(pm_heat_filt, scale="row",main = "DE HERVs, All Primary vs. Pre-tx Metastatic\nCutoff p= 0.01,Top 40 HERVs Excluding Batch",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE], gaps_col = 80)
```

```{r, eval = FALSE,fig.height = 12, fig.width = 12}
png("DE HERVs Design Primary vs Metastatic.png", res = 1200, unit = "in", width = 12, height = 12)

pheatmap(pm_heat_filt, scale="row",main = "DE HERVs, All Primary vs. Pre-tx Metastatic\nCutoff p= 0.01,Top 40 HERVs Excluding Batch",fontsize = 20, size = 35, color = inferno(25), show_rownames = FALSE,cluster_cols = FALSE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE], gaps_col = 80)

```

```{r, eval = FALSE,fig.height = 12, fig.width = 12}
png("DE HERVs Design Primary vs Metastatic.Clustered.png", res = 1200, unit = "in", width = 12, height = 12)

pheatmap(pm_heat_clustering, scale="row",main = "DE HERVs Clustering, Primary vs. Pre-tx Metastatic\nCutoff p= 0.01,Top 40 HERVs",fontsize = 20, size = 35, color = inferno(25), show_rownames = FALSE,cluster_cols = TRUE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE], gaps_col = 80)

```

Volcano

```{r, fig.height = 10, fig.width = 15}
herv_res_all <- results(DESeq.herv.pm) %>% data.frame()
herv_res_all$hervs <- rownames(herv_res_all)
herv_res_all$hervs[(which(!(rownames(herv_res_all) %in% rownames(pm_heat_filt))))] <- ""
EnhancedVolcano(herv_res_all, lab = herv_res_all$hervs, x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = log2(2),title = "HERV Vocalno, Primary vs. Metastatic, p Cutoff = 0.01, Showing top 40 HERVs",titleLabSize = 30, labSize = 10,legendLabSize = 15,max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "yellow", "red2"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.text=element_text(size=25),axis.title=element_text(size=25,face="bold"))
#ggsave("Valcano HERVs_PrimaryvsMets.png")
```

#### HERVs of Interest (17 Profile HERVs from Primary paper)

```{r}
herv_profile <- c('ERVLE_17p11.2c','LTR46_Xq11.1','HERVH_6q24.1b','HERVH_3q21.3a','MER4B_3q21.2','HERVH_10q23.32','HML3_19q13.2','HERVI_9q22.1','MER4_1p21.3','HML3_3q21.2','ERVLE_5q13.2a','HERV3_19q13.42a','HERVE_Xp11.23','ERV316A3_6p21.33c','MER101_19q13.2c','ERVLE_2p13.2a','MER4B_12q22')
```

```{r}
herv_res_17 <- herv_res_all[herv_profile,,drop = FALSE]
herv_res_17_sig <- subset(herv_res_17, padj <= 0.01)
print(paste0("There are ", nrow(herv_res_17_sig), " significantly DE HERVs between primary vs. Mets. As listed:" ))
rownames(herv_res_17_sig)
herv_res_17
```

```{r}
heat_17 <- heattable(DESeq.herv.pm, herv_res_17, select_string = ".+",min_fc = 0, max_p = 1,select_genes = 17, exclude_genes = "")
herv_res_17$Significance <- ifelse(herv_res_17$padj <= 0.01, "*","NS")
herv_res_17 <- herv_res_17[order(herv_res_17$padj),]
```

```{r, fig.width = 14, fig.height = 6}
pheatmap(heat_17, scale="row",main = "Selected HERVs\nPrimary vs. Pre-tx Metastatic",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = FALSE, cluster_rows = FALSE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Cluster", drop = FALSE], annotation_row =herv_res_17[,"Significance", drop = FALSE],  gaps_col = 80)
```

#### Invidual HERV Plotting

Function to create error bars
```{r}
data_sum <- function(df, variable_row, grouping_row){
  g_factors <- as.factor(unique(df[,grouping_row]))
  sum_table <- data.frame(matrix(nrow = length(g_factors), ncol = 2))
  colnames(sum_table) <- c(variable_row, "sd")
  rownames(sum_table) <- g_factors
  for(i in 1:length(g_factors)){
    sub_mean <- mean(df[which(df[,grouping_row] == g_factors[i]),variable_row])
    sub_sd <- sd(df[which(df[,grouping_row] == g_factors[i]),variable_row])
    sum_table[i,c(1:2)] <- c(sub_mean,sub_sd)
  }
  sum_table[grouping_row] <- g_factors
  return(sum_table)
}

```


Significant count graphing 


```{r}
HML2_19q11 <- plotCounts(DESeq.herv.pm, gene = "HML2_19q11", intgroup = "Status", normalized = TRUE,returnData = TRUE)
HML2_summary<- data_sum(HML2_19q11, variable_row="count", grouping_row="Status")
ggplot(HML2_19q11, aes(x = Status, y = count)) +geom_point(aes(size = 1.5)) +  ggtitle("Normalized Counts for HML2_19q11c\nSeparated by Status")+geom_errorbar(aes(x = Status, ymin = count-sd, ymax = count+sd),data = HML2_summary, width = 0.08, col = "grey50") + geom_errorbar(aes(x = Status, ymin = count, ymax = count),data = HML2_summary, width = 0.08, col = "red2") +  theme( plot.title=element_text(size=16,face="bold"),axis.text=element_text(size=18),axis.title=element_text(size=20,face="bold"))
#ggsave("ERV316A3_3q13.12c Counts.png")
```

```{r}
ERVLE_17p11.2c <- plotCounts(DESeq.herv.pm, gene = "ERVLE_17p11.2c", intgroup = "Status", normalized = TRUE,returnData = TRUE)
ERVLE_summary<- data_sum(ERVLE_17p11.2c, variable_row="count", grouping_row="Status")
ggplot(ERVLE_17p11.2c, aes(x = Status, y = count)) +geom_point(aes(size = 1.5)) +  ggtitle("Normalized Counts for ERVLE_17p11.2c\nSeparated by Status")+geom_errorbar(aes(x = Status, ymin = count-sd, ymax = count+sd),data = ERVLE_summary, width = 0.08, col = "grey50") + geom_errorbar(aes(x = Status, ymin = count, ymax = count),data = ERVLE_summary, width = 0.08, col = "red2") +  theme( plot.title=element_text(size=16,face="bold"),axis.text=element_text(size=18),axis.title=element_text(size=20,face="bold"))
```

### Batch Genes

```{r}
load("/Users/phoebefei/Library/CloudStorage/OneDrive-med.cornell.edu/WCM/Metastatic UM Prj/primary_UM/analysis2/03-gene_data.Rdata")
#genes.annot
```

```{r}
DESeq.gene.batch <- DESeqDataSetFromMatrix(countData = as.matrix(all_genes[,rownames(batch_meta)]),
                                   colData = batch_meta,
                                   design = ~ Batch) 

```


```{r, fig.width = 10, fig.height = 6}
#size factor
DESeq.gene.batch <- estimateSizeFactors(DESeq.gene.batch)
#normalize & log-sized
DESeq.gene.batch_norm <- counts(DESeq.gene.batch, normalized = TRUE)
boxplot(log2(DESeq.gene.batch_norm+1), notch=FALSE, main = "Size-factor-normalized read counts", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.gene.batch,"log.norm.counts") <- log2(DESeq.gene.batch_norm+1)
DESeq.gene.batch <- DESeq(DESeq.gene.batch,parallel = T,test = "LRT", reduced = ~1)
```

```{r}
#resultsNames(DESeq.gene.batch)
#[1] "Intercept"              "Batch_Nilsson_vs_MSKCC"
gene_res_batch<-restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.gene.batch, cont = c("Batch","Nilsson","MSKCC"))
batch_genes <- rownames(gene_res_batch)
```


### Primary vs. Mets Genes

```{r}
#create the object
DESeq.gene.pm <- DESeqDataSetFromMatrix(countData = as.matrix(all_genes[,rownames(pm_meta)]),
                                   colData = pm_meta,
                                   design = ~ Status) 
DESeq.gene.pm$Status <- relevel(DESeq.gene.pm$Status, ref = "Primary")
```


#### Process count info 

```{r, fig.width = 10, fig.height = 6}
#size factor
DESeq.gene.pm <- estimateSizeFactors(DESeq.gene.pm)
#normalize & log-sized
DESeq.gene.pm_norm <- counts(DESeq.gene.pm, normalized = TRUE)
boxplot(log2(DESeq.gene.pm_norm+1), notch=FALSE, main = "Size-factor-normalized read counts", ylab="log2(read counts)", cex = .6, las = 2)
assay(DESeq.gene.pm,"log.norm.counts") <- log2(DESeq.gene.pm_norm+1)
```


```{r}
DESeq.gene.pm$Age <- as.numeric(DESeq.gene.pm$Age)
#SD and PCA plot
msd.gene.pm <- vsn::meanSdPlot(DESeq.gene.pm@assays@data@listData$log.norm.counts, ranks=FALSE, plot = FALSE)
msd.gene.pm$gg + ggtitle("Sequencing depth normalized log2(read counts)") + ylab("standard deviation")
DESeq.gene.pm.trans <- DESeq(DESeq.gene.pm)
gene.pm.vst <- assay(varianceStabilizingTransformation(DESeq.gene.pm.trans))
gene.pm.pca <- pca(gene.pm.vst, metadata = colData(DESeq.gene.pm.trans), removeVar = 0.1)
```

PCA Visualize

```{r}
screeplot(gene.pm.pca, axisLabSize = 18, titleLabSize = 22) + ggtitle("SCREE Plot for Genes, Primary + Metastatic")
biplot(gene.pm.pca, lab = NULL, colby = "Cluster",legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Cluster")
biplot(gene.pm.pca, lab = NULL, colby = "Status",legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Status")
biplot(gene.pm.pca, lab = NULL, colby = "toMet",legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Metastasis Development")
biplot(gene.pm.pca, lab = NULL, colby = "Batch",legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Batch")

biplot(gene.pm.pca, lab = NULL, colby = "Age", legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Age")
biplot(gene.pm.pca, lab = NULL, colby = "Sex", legendPosition = 'right') + ggtitle("PCA, Genes Primary + Mets\nColor by Sex")

```

PCA Loading Plot
```{r, fig.height = 8, fig.width = 4}
plotloadings(gene.pm.pca,
             components = getComponents(gene.pm.pca, c(1,2)),
             rangeRetain = 0.1,
             labSize = 4.0,
             title = 'Loadings plot for primary + metastatic HERVs',
             subtitle = 'PC1, PC2',
             caption = 'Top 1% variables',
             shape = 24,
             col = c('limegreen', 'black', 'red3'),
             drawConnectors = TRUE)
#max.overlap = Inf

```

```{r}
DESeq.gene.pm <- DESeq(DESeq.gene.pm,parallel = T,test = "LRT", reduced = ~1)
```

DE table on HERV

```{r}
#resultsNames(DESeq.gene.pm)
#"Intercept"                    "Status_Primary_vs_Metastatic"
#Mets vs. All
gene_res_pm<-restable(min_fc = 2, max_p = 0.01, n_top_genes = 20, DESeq.gene.pm, cont = c("Status","Metastatic","Primary"), exclude_gene = batch_genes)
```


Volcano

```{r}
pm_gene <- heattable(DESeq.gene.pm, gene_res_pm, select_string = ".+",min_fc =2, max_p = 0.01, select_genes = 40, exclude_gene=batch_genes) 
```


```{r, fig.height = 10, fig.width = 15}
gene_res_all <- results(DESeq.gene.pm) %>% data.frame()
gene_res_all$gene_names <- genes.annot[rownames(gene_res_all),"gene_name"]
gene_res_all$gene_names[which(!(rownames(gene_res_all) %in% rownames(pm_gene)))] <- ""
EnhancedVolcano(gene_res_all, lab = gene_res_all$gene_names, x = 'log2FoldChange', y = 'padj', pCutoff = 0.01,FCcutoff = log2(2),title = "Gene Vocalno, Primary vs. Metastatic, p Cutoff = 0.01, Showing top 40 Genes",titleLabSize = 30, labSize = 10,legendLabSize = 15,max.overlaps = Inf, drawConnectors = TRUE,arrowheads = FALSE,colAlpha = 1/2,col = c("black", "forestgreen", "yellow", "red2"),pointSize = 4)+theme( plot.title=element_text(size=45,face="bold"),axis.text=element_text(size=25),axis.title=element_text(size=25,face="bold"))
#ggsave("Valcano HERVs_PrimaryvsMets.png")
```

Heatmap

```{r}
rownames(pm_gene) <- genes.annot[rownames(pm_gene), "gene_name"]
```

```{r, fig.width = 12, fig.height = 12}

pheatmap(pm_gene, scale="row",main = "Primary vs. Pre-tx Metastatic Genes\n Excluding Batch, pCut = 0.01",fontsize = 20, size = 35, color = inferno(25), show_rownames = TRUE,cluster_cols = TRUE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE],  gaps_col = 80)

```

```{r, eval = FALSE, fig.width = 12, fig.height = 12}
png("PM Gene Heatmap.png", res = 1200, unit = "in", width = 12, height = 12)
pheatmap(pm_gene, scale="row",main = "Primary vs. Pre-tx Metastatic Genes\n Excluding Batch, pCut = 0.01",fontsize = 20, size = 35, color = inferno(25), show_rownames = FALSE,cluster_cols = TRUE, cluster_rows = TRUE, breaks = breaklist, legend_labels = "Expression Z-score", annotation_col = pm_meta[,"Status", drop = FALSE],  gaps_col = 80)
```

